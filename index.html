<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Legendary ONLINE - BEKA STUDIO</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1-color: #00d2ff; --p2-color: #ff416c; --field-green: #1a472a; --gold: #ffd700; }
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; touch-action: none; }

        #scoreboard { width: 100%; height: 50px; background: #111; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #333; z-index: 100; flex-shrink: 0; }
        .score-val { font-size: 1.6rem; font-weight: 900; color: white; }
        #match-tag { background: var(--gold); color: #000; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; border-radius: 4px; }

        #game-container { position: relative; width: 100vw; height: 65vh; background: var(--field-green); overflow: hidden; border-bottom: 2px solid #333; flex-shrink: 0; }
        canvas { width: 100%; height: 100%; display: block; }

        #bottom-panel { width: 100%; flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        #controls-row { width: 100%; display: none; justify-content: space-around; align-items: center; max-width: 500px; }
        .ctrl-btn { width: 45%; height: 75px; background: #222; border: 1px solid #444; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; }

        .menu-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; text-align: center; padding: 20px; }
        .btn { padding: 12px; font-size: 0.85rem; cursor: pointer; border: none; color: white; border-radius: 8px; font-weight: bold; text-transform: uppercase; width: 260px; margin: 5px; }
        .btn-green { background: #2e7d32; }
        .btn-blue { background: #1565c0; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-red { background: #c62828; }

        input { width: 260px; padding: 10px; border-radius: 5px; border: 1px solid var(--gold); background: #222; color: white; text-align: center; margin-bottom: 10px; }
        .lobby-box { width: 280px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
        
        #chat-area { width: 280px; height: 120px; background: #000; border: 1px solid #444; border-radius: 8px; display: flex; flex-direction: column; }
        #chat-msgs, #ht-msgs { flex: 1; overflow-y: auto; padding: 5px; font-size: 0.7rem; text-align: left; scroll-behavior: smooth; }
        #chat-input { width: 100%; background: #111; border: none; color: white; padding: 6px; box-sizing: border-box; }

        #credits-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 500; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .credits-content { border: 2px solid var(--gold); padding: 25px; border-radius: 15px; background: #111; text-align: center; }
        .beka-footer-btn { background: none; border: none; color: #444; font-size: 0.7rem; font-weight: bold; letter-spacing: 2px; margin-top: 10px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="credits-modal" onclick="this.style.display='none'">
    <div class="credits-content">
        <h3 style="color:var(--gold)">YAPIMCILAR</h3>
        <p>Belemir Leşkeri</p>
        <p>Kaya Kaya</p>
        <p style="font-size: 0.7rem; color: #888; border-top: 1px solid #333; margin-top: 15px; padding-top: 5px;">Programmer</p>
        <p style="color: var(--p1-color); font-weight: bold;">Gemini</p>
        <button class="btn btn-gold" style="width:100%; margin-top:15px;">KAPAT</button>
    </div>
</div>

<div id="scoreboard">
    <div class="score-val" id="s2-val" style="color:var(--p2-color)">0</div>
    <div id="match-tag">LOBİ</div>
    <div class="score-val" id="s1-val" style="color:var(--p1-color)">0</div>
</div>

<div id="game-container">
    <div id="countdown" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--gold); font-size:80px; font-weight:900; display:none; z-index:150;">3</div>

    <div id="main-menu" class="menu-layer">
        <h2 style="color:var(--gold); margin-bottom:15px;">FOOTBALL LEGENDARY</h2>
        <input type="text" id="user-name" placeholder="ADINIZI YAZIN" maxlength="12">
        <button class="btn btn-green" onclick="initPeer(true)">ODA KUR</button>
        <input type="text" id="join-id" placeholder="ODA ID GİRİN">
        <button class="btn btn-blue" onclick="initPeer(false)">ODAYA KATIL</button>
    </div>

    <div id="lobby-layer" class="menu-layer" style="display:none">
        <div class="lobby-box">
            <div style="font-size:0.75rem; margin-bottom:5px;">ODA ID: <b id="my-id-display" style="color:var(--gold)">...</b> <button onclick="copyID()" style="font-size:0.6rem;">KOPYALA</button></div>
            <ul id="player-list" style="list-style:none; padding:0; margin:5px 0; font-size:0.85rem;"></ul>
        </div>
        <div id="chat-area"><div id="chat-msgs"></div><input type="text" id="chat-input" placeholder="Mesaj yaz..."></div>
        <button id="start-btn" class="btn btn-gold" style="display:none;" onclick="hostStartGame()">OYUNU BAŞLAT</button>
        <button class="btn btn-red" onclick="location.reload()">ÇIK</button>
    </div>

    <div id="halftime-layer" class="menu-layer" style="display:none">
        <h2 style="color:var(--gold)">DEVRE ARASI</h2>
        <h3 id="halftime-timer" style="font-size:2rem;">02:00</h3>
        <div id="ht-chat" style="width:260px; height:120px; background:#000; border:1px solid var(--gold); border-radius:8px; display:flex; flex-direction:column; margin-bottom:10px;">
            <div id="ht-msgs"></div>
            <input type="text" id="ht-input" placeholder="Strateji..." style="width:100%; background:#111; color:white; border:none; padding:8px; box-sizing:border-box;">
        </div>
    </div>

    <div id="end-menu" class="menu-layer" style="display:none">
        <h2 id="winner-text" style="color:var(--gold)">KAZANDIN!</h2>
        <button class="btn btn-gold" onclick="backToLobby()">LOBİYE DÖN</button>
        <button class="btn btn-blue" onclick="location.reload()">ANA MENÜ</button>
    </div>

    <canvas id="game"></canvas>
</div>

<div id="bottom-panel">
    <div id="controls-row"><div class="ctrl-btn" id="btn-left">◀</div><div class="ctrl-btn" id="btn-right">▶</div></div>
    <button class="beka-footer-btn" onclick="document.getElementById('credits-modal').style.display='flex'">BEKA STUDIO</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let peer = null, conn = null, isHost = false, myName = "", opponentName = "Rakip";

// SESLER
const sfx = {
    gol: new Audio('gol.mp3'),
    mavi: new Audio('mavi.mp3'),
    kirmizi: new Audio('kirmizi.mp3')
};

const pW = 100, pH = 18;
let score1 = 0, score2 = 0, gameActive = false, inCountdown = false, isHalftime = false;
let p1 = { x: 0, y: 0, dx: 0, color: "#00d2ff" }, p2 = { x: 0, y: 0, dx: 0, color: "#ff416c" }, ball = { x: -100, y: -100, dx: 4, dy: 4, r: 11 };

function resize() {
    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    p1.x = p2.x = canvas.width / 2 - pW / 2; p1.y = canvas.height - 35; p2.y = 35;
}
window.addEventListener('resize', resize); resize();

function initPeer(hostMode) {
    myName = document.getElementById("user-name").value.trim() || "Oyuncu";
    isHost = hostMode; peer = new Peer();
    peer.on('open', (id) => {
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("lobby-layer").style.display = "flex";
        document.getElementById("my-id-display").innerText = id;
        updatePlayerList();
        if (!isHost) {
            const tId = document.getElementById("join-id").value;
            conn = peer.connect(tId, { metadata: { name: myName } });
            setupConnection();
        }
    });
    peer.on('connection', (c) => { conn = c; opponentName = c.metadata.name; setupConnection(); setTimeout(() => conn.send({ type: 'lobby_update', name: myName }), 500); });
}

function setupConnection() {
    conn.on('open', () => { updatePlayerList(); if (isHost) document.getElementById("start-btn").style.display = "block"; });
    conn.on('data', (data) => {
        if (data.type === 'lobby_update') { opponentName = data.name; updatePlayerList(); }
        if (data.type === 'chat') { addChat(opponentName, data.msg, "chat-msgs"); addChat(opponentName, data.msg, "ht-msgs"); }
        if (data.type === 'start_signal' || data.type === 'reset_signal') { isHalftime = false; runMatchCountdown(); }
        if (data.type === 'move') p2.x = canvas.width - data.x - pW;
        if (data.type === 'ball') { ball.x = canvas.width - data.x; ball.y = canvas.height - data.y; }
        if (data.type === 'score') { score1 = data.s1; score2 = data.s2; updateScoreUI(); }
        if (data.type === 'halftime') startHalftimeUI();
        if (data.type === 'win') { sfx[data.winnerSide].play(); showEndScreen(data.winner); }
        if (data.type === 'back_to_lobby') { document.getElementById("end-menu").style.display = "none"; document.getElementById("lobby-layer").style.display = "flex"; gameActive = false; }
    });
}

function updatePlayerList() { const list = document.getElementById("player-list"); list.innerHTML = `<li>${myName} (Host)</li>`; if (conn && conn.open) list.innerHTML += `<li>${opponentName} (Katıldı)</li>`; }

[document.getElementById("chat-input"), document.getElementById("ht-input")].forEach(input => {
    input.addEventListener("keypress", (e) => { if (e.key === "Enter") { const msg = e.target.value.trim(); if (!msg || !conn) return; conn.send({ type: 'chat', msg: msg }); addChat(myName, msg, "chat-msgs"); addChat(myName, msg, "ht-msgs"); e.target.value = ""; }});
});

function addChat(user, msg, boxId) { 
    const box = document.getElementById(boxId); 
    box.innerHTML += `<div><b style="color:var(--gold)">${user}:</b> ${msg}</div>`; 
    box.scrollTop = box.scrollHeight; 
}

function copyID() { navigator.clipboard.writeText(document.getElementById("my-id-display").innerText).then(() => alert("Kopyalandı!")); }
function hostStartGame() { if (!conn || !conn.open) return alert("Rakip bekleniyor!"); conn.send({ type: 'start_signal' }); isHalftime = false; runMatchCountdown(); }

function runMatchCountdown() {
    document.getElementById("lobby-layer").style.display = "none"; document.getElementById("halftime-layer").style.display = "none";
    document.getElementById("controls-row").style.display = "flex"; document.getElementById("match-tag").innerText = "MAÇ";
    inCountdown = true; gameActive = true; isHalftime = false;
    const cd = document.getElementById("countdown"); cd.style.display = "block";
    let count = 3; cd.innerText = count;
    let timer = setInterval(() => {
        count--;
        if (count <= 0) { 
            clearInterval(timer); cd.style.display = "none"; inCountdown = false; 
            if (isHost) { ball.x = canvas.width/2; ball.y = canvas.height/2; ball.dy = 4.5; ball.dx = (Math.random()-0.5)*5; } 
        } else cd.innerText = count;
    }, 1000);
}

function startHalftimeUI() {
    isHalftime = true; gameActive = false; document.getElementById("halftime-layer").style.display = "flex"; document.getElementById("match-tag").innerText = "DEVRE";
    let time = 120; const timerDisplay = document.getElementById("halftime-timer");
    let htInterval = setInterval(() => {
        if (!isHalftime) { clearInterval(htInterval); return; }
        time--; let min = Math.floor(time / 60), sec = time % 60;
        timerDisplay.innerText = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        if (time <= 0) { clearInterval(htInterval); if (isHost) hostStartGame(); }
    }, 1000);
}

function updateScoreUI() { document.getElementById("s1-val").innerText = score1; document.getElementById("s2-val").innerText = score2; }

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
    ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
    
    if (gameActive && !inCountdown && !isHalftime) {
        p1.x += p1.dx; p1.x = Math.max(0, Math.min(canvas.width - pW, p1.x));
        if (conn && conn.open) conn.send({ type: 'move', x: p1.x });
        
        if (isHost) {
            ball.x += ball.dx; ball.y += ball.dy;
            if (ball.x <= ball.r || ball.x >= canvas.width - ball.r) ball.dx *= -1;
            if (ball.y + ball.r > p1.y && ball.x > p1.x && ball.x < p1.x + pW) ball.dy = -Math.abs(ball.dy);
            if (ball.y - ball.r < p2.y + pH && ball.x > p2.x && ball.x < p2.x + pW) ball.dy = Math.abs(ball.dy);
            
            if (ball.y < 0) { score1++; sfx.gol.play(); checkScore(); }
            if (ball.y > canvas.height) { score2++; sfx.gol.play(); checkScore(); }
            if (conn && conn.open) conn.send({ type: 'ball', x: ball.x, y: ball.y });
        }
    }
    ctx.fillStyle = p1.color; ctx.fillRect(p1.x, p1.y, pW, pH);
    ctx.fillStyle = p2.color; ctx.fillRect(p2.x, p2.y, pW, pH);
    if (ball.x > 0) { ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2); ctx.fill(); }
    requestAnimationFrame(gameLoop);
}

function checkScore() {
    updateScoreUI(); if (conn && conn.open) conn.send({ type: 'score', s1: score1, s2: score2 });
    if ((score1 + score2) % 3 === 0 && score1 < 9 && score2 < 9) { if (isHost) conn.send({ type: 'halftime' }); startHalftimeUI(); }
    else if (score1 >= 9 || score2 >= 9) { 
        const wN = score1 >= 9 ? myName : opponentName;
        const wS = score1 >= 9 ? 'mavi' : 'kirmizi';
        sfx[wS].play();
        showEndScreen(wN); conn.send({ type: 'win', winner: wN, winnerSide: wS }); 
    }
    else { if (isHost) conn.send({ type: 'reset_signal' }); runMatchCountdown(); }
}

function showEndScreen(name) { gameActive = false; document.getElementById("halftime-layer").style.display = "none"; document.getElementById("end-menu").style.display = "flex"; document.getElementById("winner-text").innerText = name.toUpperCase() + " KAZANDI!"; document.getElementById("controls-row").style.display = "none"; }
function backToLobby() { document.getElementById("end-menu").style.display = "none"; document.getElementById("lobby-layer").style.display = "flex"; score1 = 0; score2 = 0; updateScoreUI(); if(conn) conn.send({type: 'back_to_lobby'}); }

const move = (v) => p1.dx = v;
document.getElementById("btn-left").addEventListener("touchstart", (e) => { e.preventDefault(); move(-10); });
document.getElementById("btn-right").addEventListener("touchstart", (e) => { e.preventDefault(); move(10); });
document.getElementById("btn-left").addEventListener("touchend", () => move(0));
document.getElementById("btn-right").addEventListener("touchend", () => move(0));

requestAnimationFrame(gameLoop);
</script>
</body>
</html>
