<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Legendary - Online & Bot</title>
    <style>
        :root { --p1-color: #2196F3; --p2-color: #f44336; }
        body { margin: 0; padding: 0; overflow: hidden; background: #121212; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; touch-action: none; }
        #game-container { position: relative; width: 95vw; height: 53.43vw; max-height: 95vh; max-width: 168.88vh; background: #2e7d32; border: 4px solid white; border-radius: 8px; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; position: absolute; top:0; left:0; }
        #fx-canvas { z-index: 100; pointer-events: none; }
        .menu-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; color: white; text-align: center; }
        h1 { font-size: 5vw; margin-bottom: 10px; }
        .btn { padding: 12px 30px; font-size: 1.2vw; cursor: pointer; border: none; color: white; border-radius: 50px; font-weight: bold; margin: 5px; min-width: 180px; transition: 0.2s; }
        .btn-green { background: #4CAF50; }
        .btn-blue { background: #2196F3; }
        .btn-orange { background: #ff9800; }
        #name-input { padding: 10px; border-radius: 5px; border: none; font-size: 1.2vw; margin-bottom: 15px; width: 250px; text-align: center; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; color: white; font-size: 2vw; font-weight: bold; pointer-events: none; z-index: 20; }
        #countdown { position: absolute; color: #ffeb3b; font-size: 80px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 25; display: none; text-shadow: 3px 3px 0 #000; }
        #pause-btn { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; border-radius: 50%; cursor: pointer; z-index: 60; display: none; align-items: center; justify-content: center; font-size: 20px; }
        .ctrl-btn { position: fixed; width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 25px; z-index: 40; visibility: hidden; }
        #p1-up { left: 20px; bottom: 110px; border-color: var(--p1-color); }
        #p1-down { left: 20px; bottom: 20px; border-color: var(--p1-color); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui"><span id="name1">MAVİ</span>: <span id="s1">0</span> | <span id="name2">KIRMIZI</span>: <span id="s2">0</span></div>
    <button id="pause-btn" onclick="togglePause()">⏸</button>

    <div id="main-menu" class="menu-layer">
        <h1>FUTBOL 1V1</h1>
        <input type="text" id="name-input" placeholder="Adını Yaz..." maxlength="10">
        <button class="btn btn-blue" onclick="startOnlineMode()">ONLINE OYNA (PvP)</button>
        <button class="btn btn-orange" onclick="showDifficulty()">BOTA KARŞI</button>
    </div>

    <div id="pause-menu" class="menu-layer" style="display: none;">
        <h1>DURAKLATILDI</h1>
        <button class="btn btn-green" onclick="togglePause()">DEVAM ET</button>
        <button class="btn btn-blue" onclick="location.reload()">ANA MENÜ</button>
    </div>

    <div id="end-menu" class="menu-layer" style="display: none;">
        <h1 id="winner-text">KAZANDI!</h1>
        <button class="btn btn-green" onclick="location.reload()">TEKRAR OYNA</button>
    </div>

    <div id="difficulty-menu" class="menu-layer" style="display: none;">
        <h1>ZORLUK SEÇ</h1>
        <button class="btn btn-green" onclick="startBotMode(0.06, 7, 10, 1)">KOLAY</button>
        <button class="btn btn-blue" onclick="startBotMode(0.12, 11, 18, 1)">ORTA (HIZLI)</button>
        <button class="btn btn-red" style="background:#f44336" onclick="startBotMode(0.25, 15, 14, 2)">ZOR (2 TOP)</button>
        <button class="btn" style="background:#555" onclick="backToMain()">GERİ</button>
    </div>

    <div id="waiting-layer" class="menu-layer" style="display: none;">
        <h1>RAKİP BEKLENİYOR...</h1>
        <button class="btn btn-blue" style="margin-top: 20px;" onclick="location.reload()">İPTAL VE ANA MENÜ</button>
    </div>

    <div id="countdown">3</div>
    <canvas id="game"></canvas>
    <canvas id="fx-canvas"></canvas>
</div>

<div class="ctrl-btn" id="p1-up">▲</div>
<div class="ctrl-btn" id="p1-down">▼</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const fxCanvas = document.getElementById("fx-canvas");
const fxCtx = fxCanvas.getContext("2d");
const GW = 1280, GH = 720;
canvas.width = fxCanvas.width = GW;
canvas.height = fxCanvas.height = GH;

const sounds = {
    gol: new Audio('gol.mp3'),
    mavi: new Audio('mavi.mp3'),
    kirmizi: new Audio('kirmizi.mp3')
};

function unlockSounds() {
    Object.values(sounds).forEach(s => {
        s.play().then(() => { s.pause(); s.currentTime = 0; }).catch(() => {});
    });
}

let socket, isOnline = false, gameActive = false, inCountdown = false, isPaused = false;
let score1 = 0, score2 = 0;
let p1 = { y: 300, dy: 0 }, p2 = { y: 300, dy: 0 };
let balls = [], botParams = { skill: 0.1, speed: 8, bSpeed: 10, bCount: 1 };
let particles = [];

function createFirework(x, y) {
    const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
    for (let i = 0; i < 40; i++) {
        particles.push({ x: x, y: y, dx: (Math.random() - 0.5) * 15, dy: (Math.random() - 0.5) * 15, r: Math.random() * 4 + 1, color: color, alpha: 1 });
    }
}

function updateParticles() {
    fxCtx.clearRect(0, 0, GW, GH);
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.dx; p.y += p.dy; p.dy += 0.08; p.alpha -= 0.015;
        if (p.alpha <= 0) particles.splice(i, 1);
        else { fxCtx.globalAlpha = p.alpha; fxCtx.fillStyle = p.color; fxCtx.beginPath(); fxCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2); fxCtx.fill(); }
    }
}

function startOnlineMode() {
    unlockSounds();
    const name = document.getElementById("name-input").value.trim() || "Oyuncu";
    isOnline = true;
    document.getElementById("waiting-layer").style.display = "flex";
    socket = io();
    socket.emit('joinGame', { name: name });
    socket.on('gameStart', () => {
        document.getElementById("waiting-layer").style.display = "none";
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("pause-btn").style.display = "flex";
        gameActive = true;
        document.getElementById("p1-up").style.visibility = "visible";
        document.getElementById("p1-down").style.visibility = "visible";
    });
    socket.on('update', (data) => {
        if(!isOnline || isPaused) return;
        balls = data.balls; p1.y = data.p1.y; p2.y = data.p2.y;
        score1 = data.scores.p1; score2 = data.scores.p2;
        document.getElementById("s1").innerText = score1;
        document.getElementById("s2").innerText = score2;
        document.getElementById("name1").innerText = data.names.p1;
        document.getElementById("name2").innerText = data.names.p2;
        if(score1 >= 3 || score2 >= 3) checkGameOver(data.names.p1, data.names.p2);
    });
}

function startBotMode(skill, speed, bSpeed, bCount) {
    unlockSounds();
    isOnline = false; gameActive = true;
    score1 = 0; score2 = 0;
    document.getElementById("s1").innerText = 0;
    document.getElementById("s2").innerText = 0;
    botParams = { skill, speed, bSpeed, bCount };
    document.getElementById("name1").innerText = document.getElementById("name-input").value || "OYUNCU";
    document.getElementById("name2").innerText = "BOT";
    document.getElementById("main-menu").style.display = "none";
    document.getElementById("difficulty-menu").style.display = "none";
    document.getElementById("pause-btn").style.display = "flex";
    document.getElementById("p1-up").style.visibility = "visible";
    document.getElementById("p1-down").style.visibility = "visible";
    resetLocalStage();
}

function resetLocalStage() {
    if(score1 >= 3 || score2 >= 3) return;
    balls = []; inCountdown = true;
    const countEl = document.getElementById("countdown");
    countEl.style.display = "block";
    let t = 3; countEl.innerText = t;
    let inv = setInterval(() => {
        if(isPaused) return;
        t--;
        if(t <= 0) {
            clearInterval(inv); countEl.style.display = "none"; inCountdown = false;
            for(let i=0; i<botParams.bCount; i++) {
                balls.push({ x: GW/2, y: GH/2, dx: (Math.random() > 0.5 ? 1 : -1) * botParams.bSpeed, dy: (Math.random() > 0.5 ? 0.7 : -0.7) * botParams.bSpeed, r: 12 });
            }
        } else countEl.innerText = t;
    }, 1000);
}

function checkGameOver(n1, n2) {
    if(!gameActive) return;
    gameActive = false;
    document.getElementById("end-menu").style.display = "flex";
    const winText = document.getElementById("winner-text");
    sounds.mavi.volume = 1.0; sounds.kirmizi.volume = 1.0;

    if(score1 >= 3) {
        winText.innerText = (n1 || document.getElementById("name1").innerText) + " KAZANDI!";
        winText.style.color = "var(--p1-color)";
        sounds.mavi.play();
    } else {
        winText.innerText = (n2 || document.getElementById("name2").innerText) + " KAZANDI!";
        winText.style.color = "var(--p2-color)";
        sounds.kirmizi.play();
    }

    let fireworkTimer = setInterval(() => {
        if(particles.length > 800) return; 
        createFirework(Math.random() * GW, Math.random() * GH);
    }, 100);
    setTimeout(() => clearInterval(fireworkTimer), 4000);
}

function setupControl(id, dir) {
    const btn = document.getElementById(id);
    const move = (e) => { e.preventDefault(); if(isPaused) return; if(isOnline) socket.emit('move', { dy: dir * 18 }); else p1.dy = dir * 18; };
    const stop = (e) => { e.preventDefault(); if(isOnline) socket.emit('move', { dy: 0 }); else p1.dy = 0; };
    btn.addEventListener("touchstart", move); btn.addEventListener("touchend", stop);
    btn.addEventListener("mousedown", move); btn.addEventListener("mouseup", stop);
}
setupControl("p1-up", -1); setupControl("p1-down", 1);

function updateLocal() {
    if(!gameActive || inCountdown || isOnline || isPaused) return;
    p1.y += p1.dy;
    if(balls.length > 0) {
        let target = balls.reduce((prev, curr) => (curr.x > prev.x) ? curr : prev);
        let diff = (target.y - 60) - p2.y;
        p2.y += diff * botParams.skill;
    }
    if(p1.y < 0) p1.y = 0; if(p1.y > GH-120) p1.y = GH-120;
    if(p2.y < 0) p2.y = 0; if(p2.y > GH-120) p2.y = GH-120;

    balls.forEach(b => {
        b.x += b.dx; b.y += b.dy;
        if(b.y < 12 || b.y > GH-12) b.dy *= -1;
        if(b.x < 60 && b.y > p1.y && b.y < p1.y + 120) b.dx = Math.abs(b.dx) * 1.05;
        if(b.x > GW-60 && b.y > p2.y && b.y < p2.y + 120) b.dx = -Math.abs(b.dx) * 1.05;
        
        if(b.x < 0) { 
            score2++; 
            document.getElementById("s2").innerText = score2; 
            if(score2 < 3) { sounds.gol.play(); resetLocalStage(); } 
            else checkGameOver(); 
        }
        if(b.x > GW) { 
            score1++; 
            document.getElementById("s1").innerText = score1; 
            if(score1 < 3) { sounds.gol.play(); resetLocalStage(); } 
            else checkGameOver();
        }
    });
}

function draw() {
    ctx.clearRect(0, 0, GW, GH);
    ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 5;
    ctx.strokeRect(0, 0, GW, GH);
    ctx.beginPath(); ctx.moveTo(GW/2, 0); ctx.lineTo(GW/2, GH); ctx.stroke();
    ctx.fillStyle = "#2196F3"; ctx.fillRect(40, p1.y, 20, 120);
    ctx.fillStyle = "#f44336"; ctx.fillRect(GW-60, p2.y, 20, 120);
    ctx.fillStyle = "white";
    balls.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 12, 0, Math.PI*2); ctx.fill(); });
    if(!isOnline) updateLocal();
    updateParticles();
    requestAnimationFrame(draw);
}
draw();

function togglePause() {
    if(!gameActive || inCountdown) return;
    isPaused = !isPaused;
    const pauseMenu = document.getElementById("pause-menu");
    if(isPaused) { pauseMenu.style.display = "flex"; document.getElementById("pause-btn").innerText = "▶"; }
    else { pauseMenu.style.display = "none"; document.getElementById("pause-btn").innerText = "⏸"; }
}
function showDifficulty() { document.getElementById("main-menu").style.display = "none"; document.getElementById("difficulty-menu").style.display = "flex"; }
function backToMain() { document.getElementById("main-menu").style.display = "flex"; document.getElementById("difficulty-menu").style.display = "none"; }
</script>
</body>
</html>

