<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Legendary - BEKA STUDIO</title>
    <style>
        :root { --p1-color: #00d2ff; --p2-color: #ff416c; --field-green: #1a472a; --gold: #ffd700; }
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; touch-action: none; }

        #chat-notification {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; padding: 8px 20px;
            font-weight: bold; font-size: 0.8rem; border-radius: 0 0 10px 10px;
            z-index: 300; transition: top 0.4s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #scoreboard { width: 100%; height: 60px; background: #111; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #333; z-index: 100; }
        .score-val { font-size: 1.8rem; font-weight: 900; }
        #match-tag { background: var(--gold); color: #000; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; border-radius: 4px; }

        #game-container { position: relative; width: 100vw; flex-grow: 1; background: var(--field-green); overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        .menu-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; text-align: center; padding: 20px; overflow-y: auto; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; width: 240px; }
        .btn { padding: 12px; font-size: 0.85rem; cursor: pointer; border: none; color: white; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
        .btn-blue { background: #1565c0; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-red { background: #c62828; }
        .btn-green { background: #2e7d32; }

        #name-input-container { margin-bottom: 15px; width: 240px; }
        #user-name { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--gold); background: #222; color: white; text-align: center; box-sizing: border-box; }

        .chat-box { width: 100%; max-width: 300px; height: 150px; background: rgba(0,0,0,0.5); border: 1px solid #444; border-radius: 8px; margin-top: 15px; display: flex; flex-direction: column; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 0.75rem; text-align: left; }
        .chat-input-area { display: flex; border-top: 1px solid #444; }
        .chat-input-area input { flex-grow: 1; background: #333; border: none; color: white; padding: 8px; font-size: 0.75rem; }
        .chat-input-area button { background: var(--gold); border: none; padding: 0 10px; cursor: pointer; }
        .msg-item { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .msg-user { color: var(--gold); font-weight: bold; }

        .ctrl-row { width: 100%; height: 80px; display: none; justify-content: space-around; align-items: center; background: #000; }
        .ctrl-btn { width: 45%; height: 60px; background: #222; border: 1px solid #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
        
        #pause-trigger { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(0,0,0,0.5); border: 1px solid white; color: white; border-radius: 50%; z-index: 150; display: none; align-items: center; justify-content: center; cursor: pointer; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--gold); font-size: 80px; font-weight: 900; z-index: 160; display: none; }
        .beka-footer { color: #444; font-size: 0.6rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0; }
    </style>
</head>
<body>

<div id="chat-notification">SOHBETTEN MESAJ VAR</div>

<div id="top-controls" class="ctrl-row">
    <div class="ctrl-btn" id="p2-left">◀ SOL</div>
    <div class="ctrl-btn" id="p2-right">SAĞ ▶</div>
</div>

<div id="scoreboard">
    <div class="score-val" id="s2-val" style="color:var(--p2-color)">0</div>
    <div id="match-tag">MENÜ</div>
    <div class="score-val" id="s1-val" style="color:var(--p1-color)">0</div>
</div>

<div id="game-container">
    <div id="pause-trigger" onclick="togglePause()">⏸</div>
    <div id="countdown">3</div>

    <div id="main-menu" class="menu-layer">
        <div id="name-input-container">
            <input type="text" id="user-name" placeholder="İSMİNİZİ GİRİN..." maxlength="12">
        </div>
        <h2 style="color:var(--gold); margin-bottom:15px; font-size: 1.4rem;">FOOTBALL LEGENDARY</h2>
        <div class="btn-group">
            <button class="btn btn-blue" onclick="initGame('local')">YEREL (2 OYUNCU)</button>
            <button class="btn btn-gold" onclick="startTournament()">TURNUVA MODU</button>
            <button class="btn btn-green" onclick="showOnlineSelection()">ONLINE MOD</button>
            <button class="btn" style="background:#444" onclick="showHistory()">MAÇ GEÇMİŞİ</button>
            <button class="btn" style="background:#6a1b9a" onclick="showChatScreen()">SOHBET</button>
        </div>
    </div>

    <div id="chat-only-menu" class="menu-layer" style="display:none">
        <h2>KÜRESEL SOHBET</h2>
        <div class="chat-box" style="height: 250px;">
            <div class="chat-messages" id="main-chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="main-chat-input" placeholder="Mesaj yazın...">
                <button onclick="sendChatMessage('main-chat-input')">GÖNDER</button>
            </div>
        </div>
        <button class="btn btn-blue" style="margin-top:15px" onclick="location.reload()">GERİ</button>
    </div>

    <div id="online-selection" class="menu-layer" style="display:none">
        <h2>TARAFINI SEÇ</h2>
        <div class="btn-group">
            <button class="btn btn-blue" onclick="startOnline('MAVİ')">MAVİ (ALT)</button>
            <button class="btn btn-red" onclick="startOnline('KIRMIZI')">KIRMIZI (ÜST)</button>
            <button class="btn" style="background:#444" onclick="location.reload()">GERİ</button>
        </div>
    </div>

    <div id="online-waiting" class="menu-layer" style="display:none">
        <h2 id="waiting-text">RAKİP BEKLENİYOR...</h2>
        <div class="chat-box">
            <div class="chat-messages" id="online-chat-msgs"></div>
            <div class="chat-input-area">
                <input type="text" id="online-chat-input" placeholder="Yazınız...">
                <button onclick="sendChatMessage('online-chat-input')">></button>
            </div>
        </div>
        <button class="btn btn-red" style="margin-top:20px" onclick="location.reload()">İPTAL ET</button>
    </div>

    <div id="pause-menu" class="menu-layer" style="display:none">
        <h2>OYUN DURDU</h2>
        <div class="btn-group">
            <button class="btn btn-gold" onclick="togglePause()">DEVAM ET</button>
            <button class="btn btn-red" onclick="location.reload()">ANA MENÜ</button>
        </div>
    </div>

    <div id="history-menu" class="menu-layer" style="display:none">
        <h2>MAÇ GEÇMİŞİ</h2>
        <div class="history-list" id="history-content"></div>
        <button class="btn btn-blue" style="margin-top:15px" onclick="location.reload()">GERİ</button>
    </div>

    <div id="end-menu" class="menu-layer" style="display:none">
        <h2 id="result-text">BİTTİ</h2>
        <button id="next-btn" class="btn btn-gold" style="display:none" onclick="playNextRound()">SIRADAKİ TUR</button>
        <button class="btn btn-blue" onclick="location.reload()">ANA MENÜ</button>
    </div>

    <canvas id="game"></canvas>
</div>

<div id="bottom-controls" class="ctrl-row">
    <div class="ctrl-btn" id="p1-left">◀ SOL</div>
    <div class="ctrl-btn" id="p1-right">SAĞ ▶</div>
</div>
<div class="beka-footer">BEKA STUDIO</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// İLETİŞİM KANALI (Mesajların karşılıklı gitmesini sağlar)
const chatChannel = new BroadcastChannel('football_legendary_chat');

function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
window.addEventListener('resize', resize); resize();

let score1 = 0, score2 = 0, gameActive = false, inCountdown = false, isPaused = false;
let mode = 'local', currentRound = 0, ballSpeed = 8, ballCount = 1, botSkill = 0.1;
let balls = [];
const pW = 110, pH = 18;
const p1 = { x: 0, y: 0, dx: 0, color: "#00d2ff" };
const p2 = { x: 0, y: 0, dx: 0, color: "#ff416c" };

const rounds = [
    { name: "ÇEYREK FİNAL", skill: 0.06, speed: 8, count: 1 },
    { name: "YARI FİNAL", skill: 0.10, speed: 10, count: 1 },
    { name: "FİNAL", skill: 0.15, speed: 12, count: 2 }
];

// SOHBET MEKANİZMASI
chatChannel.onmessage = (event) => {
    const { name, message, time } = event.data;
    addMessageToUI(name, message, time);
    triggerNotification();
};

function addMessageToUI(name, message, time) {
    const msgHTML = `<div class="msg-item"><span style="color:#888;font-size:0.6rem;">[${time}]</span> <span class="msg-user">${name}:</span> <span>${message}</span></div>`;
    document.getElementById('main-chat-msgs').innerHTML += msgHTML;
    document.getElementById('online-chat-msgs').innerHTML += msgHTML;
    // Otomatik aşağı kaydır
    document.getElementById('main-chat-msgs').scrollTop = document.getElementById('main-chat-msgs').scrollHeight;
    document.getElementById('online-chat-msgs').scrollTop = document.getElementById('online-chat-msgs').scrollHeight;
}

function sendChatMessage(inputId) {
    const input = document.getElementById(inputId);
    const name = document.getElementById("user-name").value.trim() || "Misafir";
    const message = input.value.trim();
    
    if(message !== "") {
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        // Kendi ekranına ekle
        addMessageToUI(name, message, time);
        // Karşı tarafa gönder
        chatChannel.postMessage({ name, message, time });
        input.value = "";
    }
}

function triggerNotification() {
    if(gameActive) return;
    const notify = document.getElementById("chat-notification");
    notify.style.top = "0px";
    setTimeout(() => { notify.style.top = "-50px"; }, 3000);
}

function showChatScreen() {
    document.getElementById("main-menu").style.display = "none";
    document.getElementById("chat-only-menu").style.display = "flex";
}

function showOnlineSelection() {
    document.getElementById("main-menu").style.display = "none";
    document.getElementById("online-selection").style.display = "flex";
}

function startOnline(side) {
    document.getElementById("online-selection").style.display = "none";
    document.getElementById("online-waiting").style.display = "flex";
    // Not: Gerçek WebSocket sunucusu olmadan oyun başlamaz, sadece bekleme simüle edilir.
}

function initGame(m) {
    mode = m;
    score1 = 0; score2 = 0;
    p1.x = p2.x = canvas.width/2 - pW/2;
    p1.y = canvas.height - 40; p2.y = 40;
    document.getElementById("bottom-controls").style.display = "flex";
    if(mode === 'local') document.getElementById("top-controls").style.display = "flex";
    document.getElementById("pause-trigger").style.display = "flex";
    document.querySelectorAll('.menu-layer').forEach(l => l.style.display = 'none');
    gameActive = true; isPaused = false;
    resetBall();
}

function startTournament() { mode = 'bot'; currentRound = 0; playNextRound(); }
function playNextRound() {
    const r = rounds[currentRound];
    botSkill = r.skill; ballSpeed = r.speed; ballCount = r.count;
    document.getElementById("match-tag").innerText = r.name;
    initGame('bot');
}

function resetBall() {
    inCountdown = true; balls = [];
    if(score1 >= 3 || score2 >= 3) { finishGame(); return; }
    document.getElementById("s1-val").innerText = score1;
    document.getElementById("s2-val").innerText = score2;
    const cd = document.getElementById("countdown");
    cd.style.display = "block";
    let count = 3; cd.innerText = count;
    let timer = setInterval(() => {
        if(isPaused) return;
        count--;
        if(count <= 0) {
            clearInterval(timer); cd.style.display = "none"; inCountdown = false;
            for(let i=0; i<ballCount; i++) {
                balls.push({ x: canvas.width/2, y: canvas.height/2, dx: (Math.random()-0.5)*ballSpeed, dy: (i===0?1:-1)*ballSpeed, r: 12 });
            }
        } else cd.innerText = count;
    }, 700);
}

function togglePause() {
    if(!gameActive || inCountdown) return;
    isPaused = !isPaused;
    document.getElementById("pause-menu").style.display = isPaused ? "flex" : "none";
}

function showHistory() {
    document.getElementById("main-menu").style.display = "none";
    document.getElementById("history-menu").style.display = "flex";
    let history = JSON.parse(localStorage.getItem('matchHistory') || '[]');
    document.getElementById("history-content").innerHTML = history.length ? 
        history.map(m => `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333; font-size:0.75rem;"><span>${m.date}</span><b>${m.score}</b><span style="color:${m.winner==='MAVİ'?'#00d2ff':'#ff416c'}">${m.winner}</span></div>`).join('') : "Henüz maç yapılmadı.";
}

function finishGame() {
    gameActive = false;
    document.getElementById("bottom-controls").style.display = "none";
    document.getElementById("top-controls").style.display = "none";
    document.getElementById("pause-trigger").style.display = "none";
    document.getElementById("end-menu").style.display = "flex";
    document.getElementById("result-text").innerText = score1 >= 3 ? "MAVİ KAZANDI!" : "KIRMIZI KAZANDI!";
    document.getElementById("next-btn").style.display = (mode === 'bot' && score1 >= 3 && currentRound < 2) ? "block" : "none";
    if(score1 >= 3 && mode === 'bot') currentRound++;
}

function update() {
    if(!gameActive || inCountdown || isPaused) return;
    p1.x += p1.dx;
    if(mode === 'bot') {
        let target = balls.reduce((prev, curr) => (curr.y < prev.y ? curr : prev), balls[0]);
        if(target) p2.x += (target.x - (p2.x + pW/2)) * botSkill;
    } else p2.x += p2.dx;
    [p1, p2].forEach(p => p.x = Math.max(5, Math.min(canvas.width - pW - 5, p.x)));
    balls.forEach(b => {
        b.x += b.dx; b.y += b.dy;
        if(b.x <= b.r || b.x >= canvas.width - b.r) b.dx *= -1;
        if(b.y + b.r > p1.y && b.x > p1.x && b.x < p1.x + pW) {
            b.dx = ((b.x - (p1.x + pW/2)) / (pW/2)) * ballSpeed;
            b.dy = -Math.abs(ballSpeed); b.y = p1.y - b.r;
        }
        if(b.y - b.r < p2.y + pH && b.x > p2.x && b.x < p2.x + pW) {
            b.dx = ((b.x - (p2.x + pW/2)) / (pW/2)) * ballSpeed;
            b.dy = Math.abs(ballSpeed); b.y = p2.y + pH + b.r;
        }
        if(b.y < 0) { score1++; resetBall(); } else if(b.y > canvas.height) { score2++; resetBall(); }
    });
}

function draw() {
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    ctx.strokeRect(5,5,canvas.width-10, canvas.height-10);
    ctx.beginPath(); ctx.moveTo(5, canvas.height/2); ctx.lineTo(canvas.width-5, canvas.height/2); ctx.stroke();
    ctx.fillStyle = "#fff";
    balls.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); });
    ctx.fillStyle = p1.color; ctx.fillRect(p1.x, p1.y, pW, pH);
    ctx.fillStyle = p2.color; ctx.fillRect(p2.x, p2.y, pW, pH);
    update(); requestAnimationFrame(draw);
}

const setupBtn = (id, obj, val) => {
    const el = document.getElementById(id);
    el.ontouchstart = (e) => { e.preventDefault(); obj.dx = val; };
    el.ontouchend = (e) => { e.preventDefault(); obj.dx = 0; };
};
setupBtn("p1-left", p1, -10); setupBtn("p1-right", p1, 10);
setupBtn("p2-left", p2, -10); setupBtn("p2-right", p2, 10);
draw();
</script>
</body>
</html>
