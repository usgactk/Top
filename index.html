<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Legendary ONLINE - BEKA STUDIO</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1-color: #00d2ff; --p2-color: #ff416c; --field-green: #1a472a; --gold: #ffd700; }
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; touch-action: none; }

        #scoreboard { width: 100%; height: 50px; background: #111; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #333; }
        .score-val { font-size: 1.5rem; font-weight: 900; }

        #game-container { position: relative; flex-grow: 1; background: var(--field-green); overflow: hidden; width: 100%; }
        canvas { width: 100%; height: 100%; display: block; }

        .menu-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; padding: 20px; }
        .btn { padding: 12px 25px; margin: 5px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-blue { background: #1565c0; color: white; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-gold { background: var(--gold); color: #000; }

        input { padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; margin: 5px; width: 200px; text-align: center; }

        /* ALT PANEL: KONTROLLER VE SOHBET */
        #bottom-panel { height: 180px; background: #111; display: none; flex-direction: row; border-top: 2px solid #333; padding: 10px; gap: 10px; }
        #controls { flex: 1; display: flex; flex-direction: column; gap: 10px; justify-content: center; }
        .ctrl-btn { height: 60px; background: #333; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; -webkit-user-select: none; }
        
        #chat-section { flex: 1.5; display: flex; flex-direction: column; background: #000; border-radius: 8px; border: 1px solid #444; overflow: hidden; }
        #chat-msgs { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 0.8rem; color: #ccc; }
        #chat-input { width: 100%; border: none; padding: 8px; background: #222; color: white; box-sizing: border-box; }

        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--gold); font-size: 80px; font-weight: 900; display: none; z-index: 150; }
        #ready-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 180; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="scoreboard">
    <div class="score-val" id="s2-val" style="color:var(--p2-color)">0</div>
    <div id="status-text" style="color:var(--gold); font-size: 0.8rem;">BAĞLANTI BEKLENİYOR</div>
    <div class="score-val" id="s1-val" style="color:var(--p1-color)">0</div>
</div>

<div id="game-container">
    <div id="countdown">3</div>
    
    <div id="ready-screen">
        <h3 id="ready-status">RAKİP BEKLENİYOR...</h3>
        <button id="ready-btn" class="btn btn-gold" onclick="sendReady()">HAZIR OL!</button>
    </div>

    <div id="main-menu" class="menu-layer">
        <h1 style="color:var(--gold)">FOOTBALL LEGENDARY</h1>
        <input type="text" id="user-name" placeholder="ADINIZ" maxlength="10">
        <button class="btn btn-green" onclick="setupPeer(true)">ODA KUR (HOST)</button>
        <div id="id-display" style="display:none; margin: 10px; font-size: 0.9rem;">
            ID: <b id="my-id-text" style="color:var(--gold)"></b>
        </div>
        <hr style="width: 80%; border: 0.5px solid #333; margin: 15px;">
        <input type="text" id="join-id" placeholder="ODA ID GİRİN">
        <button class="btn btn-blue" onclick="setupPeer(false)">ODAYA KATIL</button>
    </div>

    <canvas id="game"></canvas>
</div>

<div id="bottom-panel">
    <div id="controls">
        <div class="ctrl-btn" id="btn-left">◀ SOL</div>
        <div class="ctrl-btn" id="btn-right">SAĞ ▶</div>
    </div>
    <div id="chat-section">
        <div id="chat-msgs"></div>
        <input type="text" id="chat-input" placeholder="Mesaj yaz...">
    </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let peer = null, conn = null, isHost = false, myName = "Oyuncu";
let amIReady = false, isOpponentReady = false;

let score1 = 0, score2 = 0, gameActive = false, inCountdown = false;
const pW = 100, pH = 15;
let p1 = { x: 0, y: 0, dx: 0, color: "#00d2ff" }; // Yerel Oyuncu
let p2 = { x: 0, y: 0, dx: 0, color: "#ff416c" }; // Rakip
let ball = { x: -100, y: -100, dx: 4, dy: 4, r: 10 };

function resize() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    p1.y = canvas.height - 30;
    p2.y = 30;
    if(!gameActive) { p1.x = p2.x = canvas.width/2 - pW/2; }
}
window.addEventListener('resize', resize);
resize();

function setupPeer(asHost) {
    isHost = asHost;
    myName = document.getElementById("user-name").value || "Oyuncu";
    peer = new Peer();

    peer.on('open', (id) => {
        if(isHost) {
            document.getElementById("id-display").style.display = "block";
            document.getElementById("my-id-text").innerText = id;
            addChat("SİSTEM", "Oda kuruldu, ID'yi arkadaşına gönder.");
        } else {
            const targetId = document.getElementById("join-id").value;
            conn = peer.connect(targetId);
            initConn();
        }
    });

    peer.on('connection', (c) => {
        conn = c;
        initConn();
    });
}

function initConn() {
    conn.on('open', () => {
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("bottom-panel").style.display = "flex";
        document.getElementById("ready-screen").style.display = "flex";
        document.getElementById("status-text").innerText = "BAĞLANDI";
        resize();
        addChat("SİSTEM", "Bağlantı başarılı! Hazır butonuna bas.");
    });

    conn.on('data', (data) => {
        if(data.type === 'move') p2.x = canvas.width - data.x - pW;
        if(data.type === 'ball') { ball.x = canvas.width - data.x; ball.y = canvas.height - data.y; }
        if(data.type === 'chat') addChat("RAKİP", data.msg);
        if(data.type === 'ready') { isOpponentReady = true; checkStart(); }
        if(data.type === 'sync_score') { score1 = data.s2; score2 = data.s1; updateUI(); }
        if(data.type === 'start_game') { startCountdown(); }
    });
}

function sendReady() {
    amIReady = true;
    document.getElementById("ready-btn").style.opacity = "0.5";
    document.getElementById("ready-btn").innerText = "BEKLENİYOR...";
    conn.send({ type: 'ready' });
    checkStart();
}

function checkStart() {
    if(amIReady && isOpponentReady) {
        if(isHost) {
            conn.send({ type: 'start_game' });
            startCountdown();
        }
    } else if (isOpponentReady) {
        document.getElementById("ready-status").innerText = "RAKİP HAZIR!";
    }
}

function startCountdown() {
    document.getElementById("ready-screen").style.display = "none";
    inCountdown = true;
    gameActive = true;
    let count = 3;
    const cd = document.getElementById("countdown");
    cd.style.display = "block";
    cd.innerText = count;

    let timer = setInterval(() => {
        count--;
        if(count <= 0) {
            clearInterval(timer);
            cd.style.display = "none";
            inCountdown = false;
            if(isHost) resetBall();
        } else {
            cd.innerText = count;
        }
    }, 1000);
}

function resetBall() {
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    ball.dx = (Math.random() > 0.5 ? 4 : -4);
    ball.dy = 4;
}

function updateUI() {
    document.getElementById("s1-val").innerText = score1;
    document.getElementById("s2-val").innerText = score2;
}

// OYUN DÖNGÜSÜ
function update() {
    if(!gameActive) { requestAnimationFrame(update); return; }

    if(!inCountdown) {
        // Kendi hareketimiz
        p1.x += p1.dx;
        p1.x = Math.max(0, Math.min(canvas.width - pW, p1.x));
        conn.send({ type: 'move', x: p1.x });

        if(isHost) {
            ball.x += ball.dx;
            ball.y += ball.dy;

            // Duvarlar
            if(ball.x < ball.r || ball.x > canvas.width - ball.r) ball.dx *= -1;

            // Raketler
            if(ball.y + ball.r > p1.y && ball.x > p1.x && ball.x < p1.x + pW) {
                ball.dy = -Math.abs(ball.dy);
                ball.dx += (ball.x - (p1.x + pW/2)) * 0.1;
            }
            if(ball.y - ball.r < p2.y + pH && ball.x > p2.x && ball.x < p2.x + pW) {
                ball.dy = Math.abs(ball.dy);
                ball.dx += (ball.x - (p2.x + pW/2)) * 0.1;
            }

            // Sayı durumu
            if(ball.y < 0) { score1++; scorePoint(); }
            else if(ball.y > canvas.height) { score2++; scorePoint(); }

            conn.send({ type: 'ball', x: ball.x, y: ball.y });
        }
    }

    draw();
    requestAnimationFrame(update);
}

function scorePoint() {
    updateUI();
    conn.send({ type: 'sync_score', s1: score1, s2: score2 });
    resetBall();
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Saha çizgisi
    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    ctx.beginPath();
    ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2);
    ctx.stroke();

    // Top
    if(gameActive) {
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fill();
    }

    // Raketler
    ctx.fillStyle = p1.color;
    ctx.fillRect(p1.x, p1.y, pW, pH);
    ctx.fillStyle = p2.color;
    ctx.fillRect(p2.x, p2.y, pW, pH);
}

// SOHBET
document.getElementById("chat-input").addEventListener("keypress", (e) => {
    if(e.key === "Enter" && e.target.value.trim() !== "") {
        const msg = e.target.value;
        addChat("SEN", msg);
        if(conn) conn.send({ type: 'chat', msg: msg });
        e.target.value = "";
    }
});

function addChat(sender, msg) {
    const box = document.getElementById("chat-msgs");
    box.innerHTML += `<div><b>${sender}:</b> ${msg}</div>`;
    box.scrollTop = box.scrollHeight;
}

// KONTROLLER
const handleMove = (val) => p1.dx = val;
document.getElementById("btn-left").ontouchstart = () => handleMove(-8);
document.getElementById("btn-right").ontouchstart = () => handleMove(8);
document.getElementById("btn-left").ontouchend = document.getElementById("btn-right").ontouchend = () => handleMove(0);

// Klavye
window.onkeydown = (e) => {
    if(e.key === "ArrowLeft") handleMove(-8);
    if(e.key === "ArrowRight") handleMove(8);
};
window.onkeyup = () => handleMove(0);

requestAnimationFrame(update);
</script>
</body>
</html>

