<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Legendary - Online 1v1</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #121212; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; touch-action: none; }
        #game-container { position: relative; width: 95vw; height: 53.43vw; max-height: 95vh; max-width: 168.88vh; background: #2e7d32; border: 4px solid white; border-radius: 8px; }
        canvas { width: 100%; height: 100%; display: block; }
        #ui { position: absolute; top: 10px; width: 100%; text-align: center; color: white; font-size: 2vw; font-weight: bold; pointer-events: none; z-index: 10; }
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 50; text-align: center; }
        .btn { padding: 15px 40px; font-size: 1.5vw; cursor: pointer; border: none; color: white; background: #4CAF50; border-radius: 50px; font-weight: bold; transition: 0.2s; }
        .btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <span id="p1-name">MAVİ</span>: <span id="s1">0</span> | 
        <span id="p2-name">KIRMIZI</span>: <span id="s2">0</span>
    </div>

    <div id="overlay">
        <h1 id="msg">Football Legendary</h1>
        <p id="sub-msg">Oyunun başlaması için 2 oyuncu gerekiyor.</p>
        <button id="start-btn" class="btn" onclick="connect()">OYUNA GİR</button>
    </div>

    <canvas id="game"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const msg = document.getElementById("msg");
const subMsg = document.getElementById("sub-msg");

const GW = 1280, GH = 720;
canvas.width = GW;
canvas.height = GH;

let socket;
let myId, mySide;
let players = {};
let ball = { x: GW/2, y: GH/2, r: 12 };
let scores = { left: 0, right: 0 };
let myY = GH/2 - 60;

function connect() {
    socket = io(); // Sunucuya bağlan
    document.getElementById("start-btn").style.display = "none";
    subMsg.innerText = "Sunucuya bağlanıldı, rakip bekleniyor...";

    // Kim olduğumuzu öğreniyoruz
    socket.on('init', (data) => {
        myId = data.id;
        mySide = data.side;
        msg.innerText = mySide === 'left' ? "SEN MAVİ TAKIMSIN" : "SEN KIRMIZI TAKIMSIN";
    });

    // Sunucudan gelen her güncellemeyi al
    socket.on('update', (data) => {
        players = data.players;
        ball = data.ball;
        scores = data.scores;
        
        // Eğer 2 oyuncu da varsa ekranı temizle
        if (Object.keys(players).length >= 2) {
            overlay.style.display = "none";
        }
        draw();
    });
}

// Kontroller (Mouse veya Dokunmatik)
window.addEventListener('mousemove', (e) => {
    if (!socket || !mySide) return;
    
    const rect = canvas.getBoundingClientRect();
    const scaleY = GH / rect.height;
    myY = (e.clientY - rect.top) * scaleY - 60;

    // Sınırlar
    if (myY < 0) myY = 0;
    if (myY > GH - 120) myY = GH - 120;

    // Hareketimizi sunucuya gönder
    socket.emit('move', { y: myY });
});

// Dokunmatik kontroller için
window.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const scaleY = GH / rect.height;
    myY = (touch.clientY - rect.top) * scaleY - 60;
    
    if (myY < 0) myY = 0;
    if (myY > GH - 120) myY = GH - 120;

    socket.emit('move', { y: myY });
}, { passive: false });

function draw() {
    // Sahayı temizle
    ctx.clearRect(0, 0, GW, GH);

    // Saha Çizgileri
    ctx.strokeStyle = "rgba(255,255,255,0.4)";
    ctx.lineWidth = 5;
    ctx.strokeRect(0, 0, GW, GH);
    ctx.beginPath(); ctx.moveTo(GW/2, 0); ctx.lineTo(GW/2, GH); ctx.stroke();
    ctx.beginPath(); ctx.arc(GW/2, GH/2, 80, 0, Math.PI*2); ctx.stroke();

    // Skorları Güncelle
    document.getElementById("s1").innerText = scores.left;
    document.getElementById("s2").innerText = scores.right;

    // Oyuncuları Çiz
    Object.values(players).forEach(p => {
        ctx.fillStyle = p.side === 'left' ? "#2196F3" : "#f44336";
        const xPos = p.side === 'left' ? 40 : GW - 60;
        ctx.fillRect(xPos, p.y, 20, 120);
        
        // Kendi raketimizin etrafına beyaz bir çerçeve çizelim ki karışmasın
        if (p.id === myId) {
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.strokeRect(xPos, p.y, 20, 120);
        }
    });

    // Topu Çiz
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
    ctx.fill();
}
</script>
</body>
</html>

