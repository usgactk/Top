<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Legendary ONLINE - BEKA STUDIO</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1-color: #00d2ff; --p2-color: #ff416c; --field-green: #1a472a; --gold: #ffd700; }
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; touch-action: none; }

        /* SKORBORD */
        #scoreboard { width: 100%; height: 60px; background: #111; display: flex; justify-content: space-around; align-items: center; border-bottom: 2px solid #333; z-index: 100; }
        .score-val { font-size: 1.8rem; font-weight: 900; }
        #match-tag { background: var(--gold); color: #000; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; border-radius: 4px; }

        /* OYUN ALANI */
        #game-container { position: relative; width: 100vw; flex-grow: 1; background: var(--field-green); overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        /* MENÜLER */
        .menu-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; color: white; text-align: center; padding: 20px; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; width: 260px; }
        .btn { padding: 12px; font-size: 0.85rem; cursor: pointer; border: none; color: white; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
        .btn-blue { background: #1565c0; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-green { background: #2e7d32; }

        /* İSİM VE ONLINE GİRİŞ */
        input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--gold); background: #222; color: white; text-align: center; margin-bottom: 10px; box-sizing: border-box; }

        /* SOHBET */
        .chat-box { width: 100%; max-width: 300px; height: 120px; background: rgba(0,0,0,0.5); border: 1px solid #444; border-radius: 8px; margin-top: 10px; display: flex; flex-direction: column; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 0.7rem; text-align: left; }
        
        /* KONTROLLER */
        .ctrl-row { width: 100%; height: 80px; display: none; justify-content: space-around; align-items: center; background: #000; }
        .ctrl-btn { width: 45%; height: 60px; background: #222; border: 1px solid #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
        
        #status-bar { position: absolute; top: 0; width: 100%; background: var(--gold); color: black; font-size: 0.7rem; font-weight: bold; text-align: center; padding: 2px; z-index: 400; display: none; }
        .beka-footer { color: #444; font-size: 0.6rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0; }
    </style>
</head>
<body>

<div id="status-bar"></div>

<div id="scoreboard">
    <div class="score-val" id="s2-val" style="color:var(--p2-color)">0</div>
    <div id="match-tag">ONLINE</div>
    <div class="score-val" id="s1-val" style="color:var(--p1-color)">0</div>
</div>

<div id="game-container">
    <div id="main-menu" class="menu-layer">
        <h2 style="color:var(--gold); margin-bottom:10px;">FOOTBALL ONLINE</h2>
        <input type="text" id="user-name" placeholder="İSMİNİZİ YAZIN" maxlength="10">
        
        <div class="btn-group">
            <button class="btn btn-green" onclick="createRoom()">ODA KUR (HOST)</button>
            <div style="display:flex; gap:5px;">
                <input type="text" id="join-id" placeholder="ODA ID GİRİN" style="margin:0; flex:1;">
                <button class="btn btn-blue" style="width:auto;" onclick="joinRoom()">KATIL</button>
            </div>
            <p id="my-id-display" style="font-size:0.7rem; color:var(--gold); word-break:break-all;"></p>
        </div>
        <div class="beka-footer" style="margin-top:20px">BEKA STUDIO</div>
    </div>

    <div id="waiting-screen" class="menu-layer" style="display:none">
        <h3 id="wait-msg">RAKİP BEKLENİYOR...</h3>
        <div class="chat-box">
            <div class="chat-messages" id="chat-msgs"></div>
            <div style="display:flex;">
                <input type="text" id="chat-input" placeholder="Mesaj..." style="margin:0; flex:1; border-radius:0;">
                <button onclick="sendChat()" style="background:var(--gold); border:none; padding:0 10px;">></button>
            </div>
        </div>
        <button class="btn btn-red" style="margin-top:10px" onclick="location.reload()">İPTAL</button>
    </div>

    <canvas id="game"></canvas>
</div>

<div id="controls" class="ctrl-row">
    <div class="ctrl-btn" id="btn-left">◀ SOL</div>
    <div class="ctrl-btn" id="btn-right">SAĞ ▶</div>
</div>
<div class="beka-footer">BEKA STUDIO</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let peer, conn;
let isHost = false;
let myName = "Misafir";

// Oyun Değişkenleri
let score1 = 0, score2 = 0, gameActive = false;
const pW = 110, pH = 18;
const p1 = { x: 0, y: 0, dx: 0, color: "#00d2ff" }; // Alt (Ben)
const p2 = { x: 0, y: 0, dx: 0, color: "#ff416c" }; // Üst (Rakip)
let ball = { x: 0, y: 0, dx: 5, dy: 5, r: 12 };

function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
window.addEventListener('resize', resize); resize();

// ONLINE BAĞLANTI SİSTEMİ
function createRoom() {
    myName = document.getElementById("user-name").value || "Host";
    peer = new Peer(); 
    peer.on('open', (id) => {
        document.getElementById("my-id-display").innerText = "ODA ID: " + id;
        document.getElementById("main-menu").style.display = "none";
        document.getElementById("waiting-screen").style.display = "flex";
        isHost = true;
    });
    peer.on('connection', (c) => {
        conn = c;
        setupConnection();
    });
}

function joinRoom() {
    const targetId = document.getElementById("join-id").value;
    if(!targetId) return alert("ID Girmelisin!");
    myName = document.getElementById("user-name").value || "Katılımcı";
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect(targetId);
        isHost = false;
        setupConnection();
    });
}

function setupConnection() {
    conn.on('open', () => {
        document.getElementById("waiting-screen").style.display = "none";
        document.getElementById("controls").style.display = "flex";
        initGame();
        
        // Veri alma
        conn.on('data', (data) => {
            if(data.type === 'move') {
                p2.x = canvas.width - data.x - pW; // Görüntüyü ters çevir (karşılıklı hissi)
            } else if(data.type === 'ball' && !isHost) {
                ball.x = canvas.width - data.x;
                ball.y = canvas.height - data.y;
            } else if(data.type === 'score') {
                score1 = data.s2; score2 = data.s1;
                updateUI();
            } else if(data.type === 'chat') {
                addChat(data.name, data.msg);
            }
        });
    });
}

function sendChat() {
    const input = document.getElementById("chat-input");
    if(!input.value) return;
    conn.send({ type: 'chat', name: myName, msg: input.value });
    addChat(myName, input.value);
    input.value = "";
}

function addChat(name, msg) {
    const box = document.getElementById("chat-msgs");
    box.innerHTML += `<div><b>${name}:</b> ${msg}</div>`;
    box.scrollTop = box.scrollHeight;
}

// OYUN MANTITI
function initGame() {
    p1.x = p2.x = canvas.width/2 - pW/2;
    p1.y = canvas.height - 40; p2.y = 40;
    ball.x = canvas.width/2; ball.y = canvas.height/2;
    gameActive = true;
    updateUI();
    requestAnimationFrame(gameLoop);
}

function updateUI() {
    document.getElementById("s1-val").innerText = score1;
    document.getElementById("s2-val").innerText = score2;
}

function gameLoop() {
    if(!gameActive) return;

    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    // Saha Çizimi
    ctx.strokeStyle = "rgba(255,255,255,0.1)";
    ctx.strokeRect(5,5,canvas.width-10, canvas.height-10);
    ctx.beginPath(); ctx.moveTo(5, canvas.height/2); ctx.lineTo(canvas.width-5, canvas.height/2); ctx.stroke();

    // Hareketler
    p1.x += p1.dx;
    p1.x = Math.max(5, Math.min(canvas.width - pW - 5, p1.x));
    
    // Pozisyonu gönder
    conn.send({ type: 'move', x: p1.x });

    // Top Mantığı (Sadece Host topu hesaplar, gecikmeyi önlemek için)
    if(isHost) {
        ball.x += ball.dx; ball.y += ball.dy;
        if(ball.x <= ball.r || ball.x >= canvas.width - ball.r) ball.dx *= -1;

        if(ball.y + ball.r > p1.y && ball.x > p1.x && ball.x < p1.x + pW) {
            ball.dy = -Math.abs(ball.dy);
            ball.dx = ((ball.x - (p1.x + pW/2)) / (pW/2)) * 7;
        }
        if(ball.y - ball.r < p2.y + pH && ball.x > p2.x && ball.x < p2.x + pW) {
            ball.dy = Math.abs(ball.dy);
            ball.dx = ((ball.x - (p2.x + pW/2)) / (pW/2)) * 7;
        }

        if(ball.y < 0) { score1++; resetBall(); sendScore(); }
        if(ball.y > canvas.height) { score2++; resetBall(); sendScore(); }

        conn.send({ type: 'ball', x: ball.x, y: ball.y });
    }

    // Çizim
    ctx.fillStyle = "#fff";
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = p1.color; ctx.fillRect(p1.x, p1.y, pW, pH);
    ctx.fillStyle = p2.color; ctx.fillRect(p2.x, p2.y, pW, pH);

    requestAnimationFrame(gameLoop);
}

function resetBall() {
    ball.x = canvas.width/2; ball.y = canvas.height/2;
    ball.dy *= -1;
    updateUI();
}

function sendScore() {
    conn.send({ type: 'score', s1: score1, s2: score2 });
}

// Kontroller
const move = (v) => p1.dx = v;
document.getElementById("btn-left").ontouchstart = (e) => { e.preventDefault(); move(-10); };
document.getElementById("btn-right").ontouchstart = (e) => { e.preventDefault(); move(10); };
document.getElementById("btn-left").ontouchend = document.getElementById("btn-right").ontouchend = (e) => { e.preventDefault(); move(0); };

</script>
</body>
</html>
